<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fixtures - SONAIJURI ANCHAL TENNIS PREMIER LEAGUE</title>

    <!-- DNS Pre-connect for Supabase (Speeds up connection on mobile ISPs) -->
    <link rel="dns-prefetch" href="https://lsikcaybolgsfimwtkdv.supabase.co">
    <link rel="preconnect" href="https://lsikcaybolgsfimwtkdv.supabase.co" crossorigin>

    <link rel="stylesheet" href="home.css">
    <link rel="stylesheet" href="styles.css">
    <style>
        .fixtures-hero {
            padding: 120px 0 60px;
            text-align: center;
            background: radial-gradient(circle at 50% 0%, rgba(0, 242, 255, 0.1) 0%, transparent 50%);
        }

        .filter-tabs {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 40px;
        }

        .tab-btn {
            padding: 12px 25px;
            border-radius: 30px;
            border: 1px solid var(--glass-border);
            background: var(--glass-bg);
            color: var(--text-dim);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 600;
            backdrop-filter: blur(5px);
        }

        .tab-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            box-shadow: 0 0 20px var(--primary-glow);
            transform: translateY(-2px);
        }

        .fixtures-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }

        .fixture-card {
            position: relative;
            padding: 25px;
            border-radius: 20px;
            transition: all 0.4s ease;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .fixture-card:hover {
            transform: translateY(-8px);
            border-color: var(--primary);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
        }

        .card-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
            color: var(--text-dim);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            padding-bottom: 12px;
        }

        .match-badge {
            background: var(--glass-bg);
            padding: 4px 10px;
            border-radius: 5px;
            border: 1px solid var(--glass-border);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 700;
        }

        .status-pill {
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 800;
            text-transform: uppercase;
            font-size: 0.65rem;
        }

        .status-live {
            background: rgba(255, 0, 0, 0.15);
            color: #ff4d4d;
            border: 1px solid #ff4d4d;
            box-shadow: 0 0 10px rgba(255, 77, 77, 0.2);
            animation: pulse-border 2s infinite;
        }

        .status-completed {
            background: rgba(0, 255, 163, 0.1);
            color: var(--secondary);
            border: 1px solid var(--secondary);
        }

        .match-content {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            gap: 20px;
            text-align: center;
        }

        .team-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }

        .team-logo-wrap {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: white;
            padding: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }

        .team-logo-wrap img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }

        .team-name {
            font-size: 1.1rem;
            font-weight: 800;
            white-space: nowrap;
        }

        .vs-wrap {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .vs-circle {
            width: 35px;
            height: 35px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 800;
            color: var(--text-dim);
        }

        .card-bottom {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.02);
            padding: 12px 15px;
            border-radius: 12px;
            font-size: 0.85rem;
        }

        .venue-info {
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--text-dim);
        }

        .result-text {
            text-align: center;
            width: 100%;
            color: var(--secondary);
            font-weight: 800;
            font-size: 0.9rem;
            letter-spacing: 0.5px;
        }

        .score-box {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            margin: 5px 0;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .team-score-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .team-score-name {
            font-weight: 700;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .team-score-val {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 800;
            color: var(--secondary);
            font-size: 1.1rem;
        }

        .overs-text {
            font-size: 0.75rem;
            color: var(--text-dim);
            margin-left: 5px;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: #ff4d4d;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
            box-shadow: 0 0 10px #ff4d4d;
            animation: pulse-dot 1.5s infinite;
        }

        @keyframes pulse-dot {
            0% {
                transform: scale(0.8);
                opacity: 0.5;
            }

            50% {
                transform: scale(1.2);
                opacity: 1;
            }

            100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
        }

        @keyframes pulse-border {
            0% {
                border-color: #ff4d4d;
                box-shadow: 0 0 5px rgba(255, 77, 77, 0.2);
            }

            50% {
                border-color: #ff8e8e;
                box-shadow: 0 0 15px rgba(255, 77, 77, 0.5);
            }

            100% {
                border-color: #ff4d4d;
                box-shadow: 0 0 5px rgba(255, 77, 77, 0.2);
            }
        }

        @media (max-width: 768px) {
            .fixtures-grid {
                grid-template-columns: 1fr;
            }

            .team-logo-wrap {
                width: 60px;
                height: 60px;
            }

            .team-name {
                font-size: 1rem;
            }
        }
    </style>
</head>

<body class="preloader-active">
    <!-- Premium Preloader Intro -->
    <div id="preloader">
        <div class="preloader-logo">SATPL 2026</div>
        <div class="preloader-bar"></div>
    </div>
    <div id="particles-bg"></div>
    <nav id="main-nav"></nav>

    <header class="fixtures-hero">
        <div class="container animate-fade">
            <h1 class="gradient-text" style="font-size: 3.5rem; margin-bottom: 10px;">Match Schedule</h1>
            <p style="color: var(--text-dim); font-size: 1.1rem;">Follow every moment of SATPL 2026</p>
        </div>
    </header>

    <main class="container" style="padding-bottom: 100px;">
        <div class="filter-tabs animate-fade">
            <button class="tab-btn active" onclick="filterFixtures('upcoming')">Upcoming Matches</button>
            <button class="tab-btn" onclick="filterFixtures('live')">Live Now</button>
            <button class="tab-btn" onclick="filterFixtures('completed')">Recent Results</button>
        </div>

        <div id="fixtures-list" class="fixtures-grid animate-fade">
            <!-- Cards will be injected here -->
        </div>
    </main>

    <footer class="animate-fade">
        <div class="container">
            <p>¬© 2026 SATPL Premium Experience. All rights reserved.</p>
            <div id="dev-credits-container"></div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <script src="nav-loader.js"></script>
    <script>
        let allFixtures = [];
        let teamLogos = {}; // Map of team name to logo URL

        async function loadFixtures() {
            const list = document.getElementById('fixtures-list');

            // 1. Initial Skeleton State
            list.innerHTML = Array(6).fill(0).map(() => `
                <div class="glass fixture-card" style="opacity: 0.5;">
                    <div class="skeleton-text" style="width: 100%; height: 20px;"></div>
                    <div style="display: flex; justify-content: space-around; align-items: center; padding: 20px 0;">
                        <div class="skeleton-text" style="width: 60px; height: 60px; border-radius: 50%;"></div>
                        <div class="skeleton-text" style="width: 30px;"></div>
                        <div class="skeleton-text" style="width: 60px; height: 60px; border-radius: 50%;"></div>
                    </div>
                </div>
            `).join('');

            try {
                // 2. Fetch Fixtures and Team Logos in parallel
                const [fixturesRes, teamsRes] = await Promise.all([
                    window.safeSupabaseCall(() =>
                        supabaseClient.from('fixtures').select('*').order('match_no', { ascending: true })
                    ),
                    window.safeSupabaseCall(() =>
                        supabaseClient.from('points_table').select('team_name, logo_url')
                    )
                ]);

                if (fixturesRes.error) throw fixturesRes.error;

                // 3. Map Logos
                if (teamsRes.data) {
                    teamsRes.data.forEach(t => {
                        teamLogos[t.team_name] = t.logo_url;
                    });
                }

                allFixtures = fixturesRes.data;
                console.log("Fixtures Loaded successfully:", allFixtures.length);

                // 4. Default filter
                filterFixtures('upcoming');

            } catch (err) {
                console.error("Fixture Error:", err);
                list.innerHTML = `<div class="glass" style="padding: 40px; text-align: center; color: #ff4d4d;">Failed to load fixtures. Please refresh page.</div>`;
            }
        }

        function filterFixtures(status) {
            // Update UI Tabs
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('onclick').includes(status)) btn.classList.add('active');
            });

            const list = document.getElementById('fixtures-list');
            const filtered = allFixtures.filter(f => {
                const s = (f.status || '').toLowerCase();
                const target = (status || '').toLowerCase();
                if (target === 'live') return s === 'live' || s === 'ongoing' || s === 'started';
                return s === target;
            });

            // Sort logic: Upcoming (Ascending), Results (Descending)
            if (status === 'completed') {
                filtered.sort((a, b) => (parseInt(b.match_no) || 0) - (parseInt(a.match_no) || 0));
            } else {
                filtered.sort((a, b) => (parseInt(a.match_no) || 0) - (parseInt(b.match_no) || 0));
            }

            if (filtered.length === 0) {
                list.innerHTML = `
                    <div class="glass animate-slide-up" style="grid-column: 1/-1; padding: 80px 20px; text-align: center;">
                        <div style="font-size: 3rem; margin-bottom: 20px;">üèè</div>
                        <h3 style="color: var(--text-dim);">No ${status} matches found.</h3>
                        <p style="font-size: 0.9rem; color: rgba(255,255,255,0.3); margin-top: 10px;">Check other categories for more action!</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = filtered.map((f, i) => {
                const date = new Date(f.match_date).toLocaleDateString('en-GB', {
                    day: 'numeric', month: 'short'
                });

                const logo1 = teamLogos[f.team1] || 'https://via.placeholder.com/100?text=SATPL';
                const logo2 = teamLogos[f.team2] || 'https://via.placeholder.com/100?text=SATPL';

                let statusBadge = '';
                let scoreHtml = '';

                const isLive = f.status === 'live' || f.status === 'ongoing';
                const isCompleted = f.status === 'completed';

                if (isLive) {
                    statusBadge = `<span class="status-pill status-live"><span class="live-dot"></span>Live Now</span>`;
                } else if (isCompleted) {
                    statusBadge = `<span class="status-pill status-completed">Result</span>`;
                } else {
                    statusBadge = `<span>${f.match_time.substring(0, 5)} IST</span>`;
                }

                // Scoreboard Logic
                if (isLive || isCompleted || (f.t1_score !== null && f.t1_score !== undefined)) {
                    scoreHtml = `
                        <div class="score-box">
                            <div class="team-score-row">
                                <span class="team-score-name">${f.team1}</span>
                                <span class="team-score-val">
                                    ${f.t1_score || 0}/${f.t1_wickets || 0}
                                    <span class="overs-text">(${f.t1_overs || 0})</span>
                                </span>
                            </div>
                            <div class="team-score-row">
                                <span class="team-score-name">${f.team2}</span>
                                <span class="team-score-val">
                                    ${f.t2_score || 0}/${f.t2_wickets || 0}
                                    <span class="overs-text">(${f.t2_overs || 0})</span>
                                </span>
                            </div>
                        </div>
                    `;
                }

                return `
                    <div class="glass fixture-card animate-slide-up" style="animation-delay: ${i * 0.1}s">
                        <div class="card-top">
                            <span class="match-badge">Match ${f.match_no}</span>
                            <span style="font-weight: 700; color: var(--secondary);">${date}</span>
                            ${statusBadge}
                        </div>

                        <div class="match-content">
                            <div class="team-box">
                                <div class="team-logo-wrap">
                                    <img src="${logo1}" alt="${f.team1}" onerror="this.src='https://via.placeholder.com/100?text=üèÜ'">
                                </div>
                                <div class="team-name">${f.team1}</div>
                            </div>

                            <div class="vs-wrap">
                                <div class="vs-circle">VS</div>
                            </div>

                            <div class="team-box">
                                <div class="team-logo-wrap">
                                    <img src="${logo2}" alt="${f.team2}" onerror="this.src='https://via.placeholder.com/100?text=üèÜ'">
                                </div>
                                <div class="team-name">${f.team2}</div>
                            </div>
                        </div>

                        <div class="card-bottom">
                            <div class="venue-info">
                                üìç <span>${f.venue || "Tournament Ground"}</span>
                            </div>
                            <div style="color: var(--text-dim); font-size: 0.75rem; text-transform: uppercase; font-weight: 700;">
                                Group A
                            </div>
                        </div>

                        ${scoreHtml}
                        
                        ${isCompleted && f.winner ? `
                            <div class="result-text" style="background: rgba(0, 242, 255, 0.05); padding: 8px; border-radius: 8px;">
                                üèÜ ${f.winner === 'Draw' ? 'Match Drawn / No Result' : `${f.winner} won the match`}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // --- REAL-TIME SYNC ---
        function setupRealtime() {
            console.log("üì° Initializing Realtime Score Sync...");
            const channel = supabaseClient
                .channel('fixtures_realtime_all')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'fixtures' }, payload => {
                    console.log('üîÑ Fixture Change Received:', payload.eventType, payload.new || payload.old);

                    if (payload.eventType === 'INSERT') {
                        allFixtures.push(payload.new);
                    } else if (payload.eventType === 'UPDATE') {
                        const index = allFixtures.findIndex(f => f.id === payload.new.id);
                        if (index !== -1) allFixtures[index] = payload.new;
                    } else if (payload.eventType === 'DELETE') {
                        allFixtures = allFixtures.filter(f => f.id !== payload.old.id);
                    }

                    // Determine current active filter and re-run it
                    const activeTab = document.querySelector('.tab-btn.active');
                    if (activeTab) {
                        const onclick = activeTab.getAttribute('onclick');
                        const statusMatch = onclick ? onclick.match(/'([^']+)'/) : null;
                        const filterType = statusMatch ? statusMatch[1] : 'upcoming';
                        filterFixtures(filterType);
                    }
                })
                .subscribe();
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadFixtures();
            setupRealtime();
        });
    </script>
</body>

</html>
