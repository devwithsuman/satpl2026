<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registration Success | SATPL 2026</title>

    <!-- DNS Pre-connect for Supabase (Speeds up connection on mobile ISPs) -->
    <link rel="dns-prefetch" href="https://lsikcaybolgsfimwtkdv.supabase.co">
    <link rel="preconnect" href="https://lsikcaybolgsfimwtkdv.supabase.co" crossorigin>

    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="id-card.css">
    <style>
        .success-wrapper {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            text-align: center;
        }

        .success-card {
            max-width: 500px;
            padding: 40px 30px;
            width: 100%;
        }

        .success-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            display: block;
        }

        .reg-number-box {
            margin: 20px 0;
            padding: 15px;
            background: var(--glass-bg);
            border-radius: 12px;
            border: 1px dashed var(--secondary);
        }

        #regNo {
            font-size: 1.5rem;
            font-weight: 800;
            letter-spacing: 2px;
            color: var(--secondary);
        }

        .id-card-capture-area {
            /* Adjust for preview */
            transform-origin: top center;
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
        }

        @media (max-width: 400px) {
            .id-card-view {
                zoom: 0.8;
            }
        }
    </style>
</head>

<body>
    <div id="particles-bg"></div>
    <div class="success-wrapper">
        <div class="success-card glass animate-fade">
            <span class="success-icon">üéâ</span>
            <h2 class="gradient-text" style="font-size: 2.5rem; margin-bottom: 10px;">Thank You for Registering!</h2>
            <p style="color: var(--text-dim);">Welcome to the SATPL 2026 family. Your registration has been confirmed.
            </p>

            <div class="reg-number-box">
                <p style="font-size: 0.9rem; margin-bottom: 5px; color: var(--text-dim);">Your Registration Number</p>
                <div id="regNo">Loading...</div>
            </div>

            <!-- New Modular ID Card Loading Area -->
            <div id="id-card-wrap" style="display: none; margin-bottom: 30px;">
                <p style="font-size: 0.9rem; color: #FF9800; margin-bottom: 15px; font-weight: 600;">Double-Sided
                    Official ID Card</p>
                <div id="id-card-preview-container">
                    <!-- This will be populated by id-card.js logic if needed, 
                         but here we just use the structure directly for capture -->
                    <div class="id-card-container" id="id-card-capture-area">
                        <!-- FRONT SIDE -->
                        <div class="id-card-view" id="id-front">
                            <div class="id-season-badge">SEASON 1: 2026</div>
                            <div class="id-header">
                                <div class="id-logo-wrap">
                                    <img src="IMG.svg" alt="SATPL">
                                    <div class="id-header-text">
                                        <h4>SATPL 2026</h4>
                                        <p>OFFICIAL PLAYER ID</p>
                                    </div>
                                </div>
                            </div>
                            <div class="id-accent-stripe"></div>
                            <div class="id-accent-stripe-2"></div>
                            <div class="id-photo-container">
                                <img id="card-photo" src="https://via.placeholder.com/150" crossorigin="anonymous">
                            </div>
                            <div class="id-wavy-bg"></div>
                            <div class="id-details-front">
                                <h1 class="id-name" id="card-name">PLAYER NAME</h1>
                                <p class="id-role" id="card-role">ALLROUNDER</p>
                                <div class="id-info-table">
                                    <div class="id-info-row">
                                        <span class="id-info-label">REG ID</span>
                                        <span class="id-info-value" id="card-reg-no">SATPL0000</span>
                                    </div>
                                    <div class="id-info-row">
                                        <span class="id-info-label">JOINED DATE</span>
                                        <span class="id-info-value">FEB 2026</span>
                                    </div>
                                    <div class="id-info-row">
                                        <span class="id-info-label">MOBILE</span>
                                        <span class="id-info-value" id="card-mobile">+91 0000000000</span>
                                    </div>
                                    <!-- <div class="id-info-row">
                                        <span class="id-info-label">SESSION</span>
                                        <span class="id-info-value">1</span>
                                    </div> -->
                                </div>
                            </div>
                        </div>

                        <!-- BACK SIDE -->
                        <div class="id-card-view" id="id-back">
                            <div class="id-back-content">
                                <div class="id-logo-wrap" style="margin-bottom: 20px;">
                                    <img src="IMG.svg" alt="SATPL" style="height: 50px;">
                                    <div class="id-header-text">
                                        <h4 style="color: white; font-size: 1rem;">SATPL 2026</h4>
                                    </div>
                                </div>
                                <div class="id-terms-section">
                                    <h5>Terms & Conditions</h5>
                                    <p class="id-terms-text">
                                        - This card is the property of Sonaijuri Anchal Tennis Premier League
                                        (SATPL).<br>
                                        - It is non-transferable and valid only for Season 1 (2026).<br>
                                        - Misuse of this ID card may lead to disqualification.<br>
                                        - Participation indicates agreement to all league rules.
                                    </p>
                                </div>
                                <div style="width: 100%; text-align: center; margin: 20px 0;">
                                    <div
                                        style="height: 1px; background: rgba(255,255,255,0.2); width: 80%; margin: 0 auto 10px;">
                                    </div>
                                    <p style="font-size: 0.5rem; letter-spacing: 5px; opacity: 0.5;">|||| ||||| || ||||
                                        |||| ||||</p>
                                </div>
                                <div class="id-qr-section">
                                    <div class="id-qr-box">
                                        <img id="qr-code" src="" alt="QR Verification">
                                    </div>
                                    <div class="id-qr-text">
                                        <p>SCAN TO DOWNLOAD</p>
                                        <p>ID CARD PDF</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div style="margin-top: 20px; display: flex; flex-direction: column; gap: 15px;">
                <button id="downloadBtn" class="btn btn-red-blink" onclick="downloadIDCard()"
                    style="display: none;">Download Digital ID Card üì•</button>


                <a href="index.html" class="btn">Back to Home</a>
                <p style="font-size: 0.8rem; color: var(--text-dim);">A copy of this registration has been sent to our
                    admin team.</p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <script src="assets-base64.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script>
        // Configure PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

        const params = new URLSearchParams(window.location.search);
        const playerToken = params.get("id");
        const errorParam = params.get("error");

        // Safe Base64 placeholder (transparent 1x1 pixel)
        const placeholder = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=';

        // Helper to convert URL to Base64 Data URL to bypass html2canvas CORS issues
        async function toBase64(url) {
            if (!url || url === placeholder || url.startsWith('data:')) return url || placeholder;
            try {
                console.log("Converting to Base64:", url);
                const response = await fetch(url, { mode: 'cors' });
                if (!response.ok) throw new Error('Fetch failed');
                const blob = await response.blob();
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result);
                    reader.readAsDataURL(blob);
                });
            } catch (e) {
                console.warn("Direct fetch failed for:", url, e.message);
                // DO NOT use canvas fallback here as it taints the main canvas later
                return placeholder;
            }
        }
        if (errorParam === 'sync_failed') {
            document.getElementById('formMessage').innerHTML = `
                <div class="glass" style="padding: 15px; border-left: 4px solid #eab308; margin-bottom: 20px;">
                    <p style="color: #eab308; margin: 0; font-size: 0.9rem;">
                        ‚ö†Ô∏è <strong>Sync Pending:</strong> Your payment was successful, but our system is still generating your ID card. 
                        Please refresh this page in a few minutes or use "Check Status" on the registration page.
                    </p>
                </div>
            `;
        }

        let playerData = null;

        async function initSuccess() {
            if (!playerToken) {
                document.getElementById("regNo").innerText = "Not Found";
                return;
            }

            // Fetch player details using TOKEN
            const { data, error } = await supabaseClient
                .from('player_registrations')
                .select('*')
                .eq('token', playerToken)
                .single();

            playerData = data;

            if (data) {
                document.getElementById("regNo").innerText = data.registration_no;
                document.getElementById('card-name').innerText = data.player_name;
                document.getElementById('card-reg-no').innerText = data.registration_no;
                document.getElementById('card-mobile').innerText = data.mobile_number || 'N/A';

                // QR Code - Points to this page with TOKEN and auto-download flag
                const currentOrigin = window.location.origin;
                const verifyUrl = `${currentOrigin}/success.html?id=${data.token}&auto_download=true`;
                const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(verifyUrl)}&bgcolor=ffffff&color=002D52`;
                document.getElementById('qr-code').src = qrUrl;

                const photoImg = document.getElementById('card-photo');
                const photoUrl = data.photo_url || placeholder;

                // Handle PDF rendering or direct Image loading
                if (photoUrl.toLowerCase().endsWith('.pdf')) {
                    (async () => {
                        try {
                            const loadingTask = pdfjsLib.getDocument(photoUrl);
                            const pdf = await loadingTask.promise;
                            const page = await pdf.getPage(1);
                            const viewport = page.getViewport({ scale: 1.5 });
                            const canvas = document.createElement('canvas');
                            const context = canvas.getContext('2d');
                            canvas.height = viewport.height;
                            canvas.width = viewport.width;
                            await page.render({ canvasContext: context, viewport: viewport }).promise;
                            photoImg.src = canvas.toDataURL('image/jpeg', 0.8);
                        } catch (err) {
                            photoImg.src = placeholder;
                        }
                    })();
                } else {
                    photoImg.src = photoUrl;
                }

                // Set Logo from Base64 constant if available
                if (typeof LOGO_BASE64 !== 'undefined' && LOGO_BASE64) {
                    document.querySelectorAll('.id-logo-wrap img').forEach(img => {
                        img.src = LOGO_BASE64;
                    });
                }

                let role = "Allrounder";
                if (data.batting !== 'no' && data.bowling === 'no') role = "Batsman";
                else if (data.batting === 'no' && data.bowling !== 'no') role = "Bowler";
                if (data.wicket_keeper === 'yes' || data.wicket_keeper === true) role += " & WK";
                document.getElementById('card-role').innerText = role;

                // SHOW EVERYTHING INSTANTLY
                document.getElementById('downloadBtn').style.display = 'block';
                document.getElementById('id-card-wrap').style.display = 'block';


                // AUTO DOWNLOAD if coming from QR scan
                if (params.get("auto_download") === "true") {
                    console.log("Auto-download triggered from QR scan...");
                    setTimeout(() => {
                        downloadIDCard();
                    }, 2500);
                }
            }
        }

        async function downloadIDCard() {
            const btn = document.getElementById('downloadBtn');
            const front = document.getElementById('id-front');
            const back = document.getElementById('id-back');

            btn.innerText = "‚è≥ Preparing high-res assets...";
            btn.disabled = true;

            try {
                // High-res Heavy Asset Conversion ON DEMAND
                console.log("Executing on-demand high-res conversion...");

                // 1. Logo Handling - CRITICAL
                const logos = document.querySelectorAll('.id-logo-wrap img');
                if (typeof LOGO_BASE64 !== 'undefined' && LOGO_BASE64) {
                    logos.forEach(img => { img.src = LOGO_BASE64; });
                } else {
                    console.warn("LOGO_BASE64 missing in downloadIDCard");
                }

                // 2. QR Code -> Base64
                const qrImg = document.getElementById('qr-code');
                if (qrImg && !qrImg.src.startsWith('data:')) {
                    qrImg.src = await toBase64(qrImg.src);
                }

                // 3. Profile Photo -> Base64
                const photoImg = document.getElementById('card-photo');
                const photoUrl = (playerData && playerData.photo_url) || placeholder;

                const photoContainer = document.querySelector('.id-photo-container');
                if (photoContainer) {
                    photoContainer.style.background = 'transparent';
                    photoContainer.style.border = '6px solid white';
                }

                if (photoUrl.toLowerCase().endsWith('.pdf')) {
                    const loadingTask = pdfjsLib.getDocument(photoUrl);
                    const pdf = await loadingTask.promise;
                    const page = await pdf.getPage(1);
                    const viewport = page.getViewport({ scale: 4.0 });
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    await page.render({ canvasContext: context, viewport: viewport }).promise;
                    photoImg.src = canvas.toDataURL('image/png');
                } else if (!photoImg.src.startsWith('data:')) {
                    photoImg.src = await toBase64(photoImg.src);
                }

                // 4. FINAL SAFETY: ENSURE NO EXTERNAL ASSETS (bypass SecurityError)
                document.querySelectorAll('.id-card-container img').forEach(img => {
                    if (img.src && !img.src.startsWith('data:') && !img.src.startsWith('blob:')) {
                        console.warn("Removing non-data image to prevent SecurityError:", img.src);
                        img.src = placeholder;
                    }
                });

                await new Promise(r => setTimeout(r, 1500));

                btn.innerText = "‚è≥ Generating Professional PDF...";

                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'px',
                    format: [350, 550],
                    compress: true
                });

                const capOpts = {
                    scale: 2,
                    useCORS: true,
                    allowTaint: false,
                    scrollX: 0,
                    scrollY: -window.scrollY,
                    backgroundColor: null,
                    logging: true
                };

                console.log("Capturing Side 1...");
                const canvasF = await html2canvas(front, capOpts);
                pdf.addImage(canvasF.toDataURL('image/jpeg', 0.95), 'JPEG', 0, 0, 350, 550);

                pdf.addPage([350, 550], 'portrait');

                console.log("Capturing Side 2...");
                const canvasB = await html2canvas(back, capOpts);
                pdf.addImage(canvasB.toDataURL('image/jpeg', 0.9), 'JPEG', 0, 0, 350, 550);

                pdf.save(`SATPL_ID_Card_${playerData.registration_no}.pdf`);

                btn.innerText = "Download Digital ID Card (PDF) üì•";
                btn.disabled = false;
                console.log("PDF Downloaded Successfully!");
            } catch (err) {
                console.error("Generation detailed error:", err);
                alert("Generation Error: " + err.message);
                btn.innerText = "Download Error";
                btn.disabled = false;
            }
        }

        initSuccess();
    </script>

</body>

</html>
